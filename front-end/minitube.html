<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniTube ‚Äî √Åudio & V√≠deo</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#9fb1c9;
    --accent:#ff5252;
    --accent-2:#06d6a0;
    --surface:#0f1726;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#08101a 0%, #071018 100%);
    color:#e6eef8;
    display:flex;
    gap:18px;
    padding:18px;
  }

  /* Layout */
  .app {
    max-width:1200px;
    margin:0 auto;
    width:100%;
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:18px;
  }

  /* Sidebar / Playlist */
  .sidebar {
    background:var(--card);
    border-radius:10px;
    padding:12px;
    border:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:80vh;
  }
  .brand { display:flex; align-items:center; gap:10px; }
  .logo {
    width:44px; height:44px; border-radius:8px;
    background:linear-gradient(135deg,var(--accent), var(--accent-2));
    display:flex; align-items:center; justify-content:center; font-weight:700;
  }
  .search {
    display:flex; gap:8px;
  }
  .search input{
    flex:1; padding:8px 10px; border-radius:8px; border:none; background:var(--glass); color:inherit;
  }
  .btn { background:var(--accent); color:#021018; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
  .small { padding:6px 8px; font-size:13px; border-radius:8px; background:var(--btn, var(--glass)); color:var(--muted); border:none; cursor:pointer; }

  .playlist {
    display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:6px;
  }
  .video-item {
    display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:pointer;
    transition: background .15s;
  }
  .video-item:hover{ background: rgba(255,255,255,0.02); }
  .video-item.active { outline:2px solid rgba(255,255,255,0.04); background: linear-gradient(90deg, rgba(255,82,82,0.06), transparent); }
  .thumb{ width:110px; height:62px; background:#111; border-radius:6px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--muted); overflow:hidden; }
  .meta { flex:1; display:flex; flex-direction:column; gap:4px; }
  .title { font-weight:700; font-size:14px; }
  .sub { font-size:12px; color:var(--muted); }

  /* Main column */
  .main {
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:80vh;
  }
  .player-card {
    background:var(--card);
    border-radius:10px;
    padding:12px;
    border:1px solid rgba(255,255,255,0.03);
  }

  /* video container responsive */
  .video-wrap { position:relative; background:#000; border-radius:8px; overflow:hidden; }
  video, audio { width:100%; height:auto; display:block; background:#000; max-height:65vh; }
  .controls {
    display:flex; gap:8px; align-items:center; padding:10px 6px;
  }
  .controls .progress {
    flex:1; height:8px; background:rgba(255,255,255,0.04); border-radius:8px; overflow:hidden; position:relative; cursor:pointer;
  }
  .controls .progress .bar { position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,var(--accent), var(--accent-2)); }
  .controls button, .controls input[type="range"]{ background:transparent; color:inherit; border:none; cursor:pointer; }
  .time { font-size:12px; color:var(--muted); min-width:70px; text-align:center; }

  /* info + actions */
  .info-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px;}
  .video-info { display:flex; gap:12px; align-items:center; }
  .avatar { width:44px; height:44px; border-radius:50%; background:var(--glass); display:flex; align-items:center; justify-content:center; color:var(--muted); }
  .video-title { font-size:18px; font-weight:800; }
  .actions { display:flex; gap:8px; align-items:center; }

  /* description & comments */
  .details { margin-top:8px; color:var(--muted); font-size:14px; }
  .comments { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .comment { background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; }
  .comment strong { font-size:13px; }
  .add-comment { display:flex; gap:8px; margin-top:6px; }

  /* upload area */
  .upload {
    border:2px dashed rgba(255,255,255,0.03);
    padding:10px; border-radius:8px; display:flex; gap:8px; align-items:center; justify-content:space-between;
  }
  .upload input[type="file"] { display:none; }

  /* responsive */
  @media (max-width:980px){
    .app{ grid-template-columns: 1fr; padding-bottom:60px; }
    .sidebar{ order:2; min-height:auto; max-height:300px; }
    .main{ order:1; }
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" aria-label="Barra lateral">
      <div class="brand">
        <div class="logo">MT</div>
        <div>
          <div style="font-weight:800">MiniTube</div>
          <div style="font-size:12px;color:var(--muted)">√Åudio & V√≠deo local</div>
        </div>
      </div>

      <div class="search">
        <input id="search" placeholder="Pesquisar v√≠deos..." aria-label="Pesquisar v√≠deos">
        <button id="btnClear" class="small" title="Limpar">Limpar</button>
      </div>

      <div class="upload" id="uploadArea" title="Arraste arquivos de m√≠dia aqui">
        <div style="flex:1">
          <strong>Arraste um v√≠deo/√°udio</strong>
          <div style="font-size:12px;color:var(--muted)">ou selecione um arquivo</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <label class="small" for="fileInput">Selecionar</label>
          <input id="fileInput" type="file" accept="video/*,audio/*" />
        </div>
      </div>

      <div style="font-size:13px;color:var(--muted)">Playlist</div>
      <div class="playlist" id="playlist" role="list"></div>

      <div style="display:flex; gap:8px; justify-content:center; margin-top:auto">
        <button id="btnShuffle" class="small">Shuffle</button>
        <button id="btnClearPlaylist" class="small">Limpar playlist</button>
      </div>
    </aside>

    <main class="main">
      <section class="player-card">
        <div class="video-wrap" id="videoWrap">
          <!-- We'll swap between video and audio element depending on the file -->
          <video id="player" controls crossorigin playsinline preload="metadata">
            <!-- sample sources (public sample) -->
            <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" />
            Seu navegador n√£o suporta v√≠deo.
          </video>
        </div>

        <div class="controls" aria-hidden="false">
          <button id="playPause" aria-label="Play/Pause">‚ñ∂</button>
          <div class="time" id="time">00:00 / 00:00</div>
          <div class="progress" id="progressBar" aria-label="Barra de progresso">
            <div class="bar" id="progressFill"></div>
          </div>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="1" title="Volume" />
          <button id="btnMute" class="small" title="Mudo">üîà</button>
          <button id="btnAudioOnly" class="small" title="Modo apenas √°udio">üéß</button>
          <button id="btnFullscreen" class="small" title="Fullscreen">‚õ∂</button>
        </div>

        <div class="info-row">
          <div class="video-info">
            <div class="avatar">MT</div>
            <div>
              <div class="video-title" id="videoTitle">Big Buck Bunny (exemplo)</div>
              <div class="sub" id="videoMeta">Exemplo ‚Äî 10:34</div>
            </div>
          </div>
          <div class="actions">
            <button id="btnLike" class="btn">Curtir</button>
            <button id="btnSubscribe" class="small">Inscrever-se</button>
            <button id="btnDownload" class="small">Baixar</button>
          </div>
        </div>

        <div class="details" id="videoDesc">
          Este √© um player demo com suporte a v√≠deos locais e remotos. Use o upload para adicionar seus arquivos.
        </div>

        <div class="comments" id="commentsSection">
          <strong>Coment√°rios</strong>
          <div id="commentsList"></div>
          <div class="add-comment">
            <input id="commentInput" placeholder="Adicionar coment√°rio..." style="flex:1;padding:8px;border-radius:8px;border:none;background:var(--glass);color:inherit" />
            <button id="btnAddComment" class="small">Enviar</button>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // Elements
  const playlistEl = document.getElementById('playlist');
  const player = document.getElementById('player');
  const playPauseBtn = document.getElementById('playPause');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const timeEl = document.getElementById('time');
  const volumeEl = document.getElementById('volume');
  const btnMute = document.getElementById('btnMute');
  const btnAudioOnly = document.getElementById('btnAudioOnly');
  const btnFullscreen = document.getElementById('btnFullscreen');
  const videoTitle = document.getElementById('videoTitle');
  const videoMeta = document.getElementById('videoMeta');
  const videoDesc = document.getElementById('videoDesc');
  const btnLike = document.getElementById('btnLike');
  const btnSubscribe = document.getElementById('btnSubscribe');
  const btnDownload = document.getElementById('btnDownload');

  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const searchInput = document.getElementById('search');
  const btnClear = document.getElementById('btnClear');
  const btnShuffle = document.getElementById('btnShuffle');
  const btnClearPlaylist = document.getElementById('btnClearPlaylist');

  const commentsList = document.getElementById('commentsList');
  const commentInput = document.getElementById('commentInput');
  const btnAddComment = document.getElementById('btnAddComment');

  // State
  let playlist = []; // { id, title, src, type, duration (sec), isAudio }
  let currentIndex = 0;
  let isAudioOnly = false;

  // Preload with two public sample videos (stable public CDN)
  const samples = [
    {
      id: cryptoRandomId(),
      title: "Big Buck Bunny (sample)",
      src: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
      type: "video/mp4",
    },
    {
      id: cryptoRandomId(),
      title: "Sintel (sample)",
      src: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4",
      type: "video/mp4",
    }
  ];

  // Utils
  function cryptoRandomId(){ return Math.random().toString(36).slice(2,9); }
  function toMMSS(s){
    if (!isFinite(s) || s <= 0) return "00:00";
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const sec = Math.floor(s%60).toString().padStart(2,'0');
    return `${m}:${sec}`;
  }

  // Persistence
  const STORAGE_KEY = 'minitube_playlist_v1';
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(playlist));
  }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const arr = JSON.parse(raw);
        // keep sample + saved, but avoid duplicates
        playlist = [...samples];
        for (const p of arr) {
          // p must have src and title
          if (p && p.src && p.title) playlist.push(p);
        }
      } catch(e){ playlist = [...samples]; }
    } else {
      playlist = [...samples];
    }
  }

  // Render playlist
  function renderPlaylist(filter=""){
    playlistEl.innerHTML = '';
    playlist.forEach((item, idx) => {
      if (filter && !item.title.toLowerCase().includes(filter.toLowerCase())) return;
      const div = document.createElement('div');
      div.className = 'video-item' + (idx === currentIndex ? ' active': '');
      div.dataset.index = idx;
      div.role = 'listitem';
      div.innerHTML = `
        <div class="thumb">${ item.type && item.type.startsWith('audio') ? 'AUDIO' : 'VIDEO' }</div>
        <div class="meta">
          <div class="title">${item.title}</div>
          <div class="sub">${item.type || ''}</div>
        </div>
      `;
      div.addEventListener('click', () => {
        playIndex(idx);
      });
      playlistEl.appendChild(div);
    });
  }

  // Load selected index into player
  function playIndex(idx){
    if (idx < 0 || idx >= playlist.length) return;
    currentIndex = idx;
    const item = playlist[idx];
    // Replace source
    setPlayerSource(item.src, item.type);
    updateActiveItem();
    videoTitle.textContent = item.title;
    videoMeta.textContent = item.type + (item.duration ? ' ‚Ä¢ ' + toMMSS(item.duration) : '');
    videoDesc.textContent = item.description || 'Sem descri√ß√£o.';
    // Start playback
    player.play().catch(()=>{ /* Autoplay might be blocked */ });
  }

  function updateActiveItem(){
    const children = playlistEl.querySelectorAll('.video-item');
    children.forEach(node => {
      node.classList.toggle('active', +node.dataset.index === currentIndex);
    });
  }

  // Set player src (handles blob URLs and remote)
  function setPlayerSource(src, type){
    // Remove current sources
    while (player.firstChild) player.removeChild(player.firstChild);
    const source = document.createElement('source');
    source.src = src;
    if (type) source.type = type;
    player.appendChild(source);
    player.load();
    // If it's audio file, and we want video element to only show audio: keep video but we can toggle poster / height
    if (type && type.startsWith('audio')) {
      // hide video visuals by setting height small
      player.style.maxHeight = '120px';
    } else {
      player.style.maxHeight = '65vh';
    }
  }

  // Events: player updates progress/time
  player.addEventListener('timeupdate', () => {
    const pct = player.duration ? (player.currentTime / player.duration) * 100 : 0;
    progressFill.style.width = pct + '%';
    timeEl.textContent = `${ toMMSS(player.currentTime) } / ${ toMMSS(player.duration) }`;
  });

  player.addEventListener('ended', () => {
    // auto-next
    if (currentIndex < playlist.length -1) {
      playIndex(currentIndex + 1);
    } else {
      // stop
    }
  });

  // Play/pause button
  playPauseBtn.addEventListener('click', () => {
    if (player.paused) player.play();
    else player.pause();
  });

  // Keep play/pause label updated
  player.addEventListener('play', () => playPauseBtn.textContent = '‚è∏');
  player.addEventListener('pause', () => playPauseBtn.textContent = '‚ñ∂');

  // Click progress to seek
  progressBar.addEventListener('click', (e) => {
    const rect = progressBar.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const pct = x / rect.width;
    if (player.duration) player.currentTime = pct * player.duration;
  });

  // Volume
  volumeEl.addEventListener('input', (e) => {
    player.volume = Number(e.target.value);
  });

  btnMute.addEventListener('click', () => {
    player.muted = !player.muted;
    btnMute.textContent = player.muted ? 'üîá' : 'üîà';
  });

  // Audio-only toggle (switches to audio look)
  btnAudioOnly.addEventListener('click', () => {
    isAudioOnly = !isAudioOnly;
    if (isAudioOnly) {
      videoWrapStyleForAudio(true);
      btnAudioOnly.textContent = 'üéûÔ∏è';
    } else {
      videoWrapStyleForAudio(false);
      btnAudioOnly.textContent = 'üéß';
    }
  });

  function videoWrapStyleForAudio(yes){
    const vwrap = document.getElementById('videoWrap');
    if (yes) {
      vwrap.style.background = '#07070a';
      player.style.objectFit = 'contain';
      player.style.height = '120px';
    } else {
      vwrap.style.background = '';
      player.style.height = '';
    }
  }

  // Fullscreen
  btnFullscreen.addEventListener('click', () => {
    const el = document.querySelector('.video-wrap');
    if (!document.fullscreenElement) el.requestFullscreen?.();
    else document.exitFullscreen?.();
  });

  // Like / subscribe / download (basic behaviors)
  let liked = false, subscribed = false;
  btnLike.addEventListener('click', () => {
    liked = !liked;
    btnLike.textContent = liked ? 'Curtido ‚úì' : 'Curtir';
  });
  btnSubscribe.addEventListener('click', () => {
    subscribed = !subscribed;
    btnSubscribe.textContent = subscribed ? 'Inscrito' : 'Inscrever-se';
  });
  btnDownload.addEventListener('click', () => {
    const item = playlist[currentIndex];
    if (!item) return;
    // create temporary link
    const a = document.createElement('a');
    a.href = item.src;
    a.download = item.title;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // Upload area - drag & drop + file input
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'rgba(255,255,255,0.12)'; });
  uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); uploadArea.style.borderColor = '';
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  });
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    handleFiles(files);
    fileInput.value = '';
  });

  function handleFiles(files){
    for (const f of files) {
      if (!f.type.startsWith('video') && !f.type.startsWith('audio')) continue;
      const blobUrl = URL.createObjectURL(f);
      const item = {
        id: cryptoRandomId(),
        title: f.name,
        src: blobUrl,
        type: f.type
      };
      playlist.push(item);
      // attempt to read duration asynchronously by loading into hidden media element
      probeDuration(item).then(dur => { item.duration = dur; saveState(); renderPlaylist(searchInput.value); });
    }
    saveState();
    renderPlaylist(searchInput.value);
  }

  async function probeDuration(item){
    return new Promise((resolve) => {
      const media = document.createElement(item.type.startsWith('audio') ? 'audio' : 'video');
      media.preload = 'metadata';
      media.src = item.src;
      media.addEventListener('loadedmetadata', () => {
        resolve(media.duration || 0);
        media.remove();
      });
      // fallback in case can't load
      setTimeout(()=>resolve(0), 3000);
    });
  }

  // Search + clear
  searchInput.addEventListener('input', (e) => renderPlaylist(e.target.value));
  btnClear.addEventListener('click', () => { searchInput.value = ''; renderPlaylist(); });

  // Shuffle playlist
  btnShuffle.addEventListener('click', () => {
    for (let i = playlist.length -1; i > 0; i--){
      const j = Math.floor(Math.random() * (i+1));
      [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
    }
    saveState();
    renderPlaylist(searchInput.value);
  });

  // Clear playlist (keep samples)
  btnClearPlaylist.addEventListener('click', () => {
    playlist = [...samples];
    saveState();
    currentIndex = 0;
    renderPlaylist();
  });

  // Comments (local only)
  const COMMENTS_KEY = 'minitube_comments_v1';
  function loadComments(){
    const raw = localStorage.getItem(COMMENTS_KEY);
    return raw ? JSON.parse(raw) : {}; // map videoId -> [comments]
  }
  function saveComments(map){
    localStorage.setItem(COMMENTS_KEY, JSON.stringify(map));
  }

  function renderComments(){
    const map = loadComments();
    const item = playlist[currentIndex];
    const arr = (map[item?.id] || []);
    commentsList.innerHTML = '';
    arr.forEach(c => {
      const div = document.createElement('div');
      div.className = 'comment';
      div.innerHTML = `<strong>${c.user}</strong> <div style="font-size:13px;color:var(--muted)">${c.text}</div>`;
      commentsList.appendChild(div);
    });
  }

  btnAddComment.addEventListener('click', () => {
    const txt = commentInput.value.trim();
    if (!txt) return;
    const map = loadComments();
    const item = playlist[currentIndex];
    if (!map[item.id]) map[item.id] = [];
    map[item.id].unshift({ user: 'Visitante', text: txt, date: Date.now() });
    saveComments(map);
    commentInput.value = '';
    renderComments();
  });

  // Download initial metadata (duration) for sample items
  async function preloadSamples(){
    for (const s of playlist) {
      if (!s.duration) {
        s.duration = await probeDuration(s);
      }
    }
  }

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.code === 'Space') { e.preventDefault(); if (player.paused) player.play(); else player.pause(); }
    if (e.key === 'ArrowRight') player.currentTime = Math.min(player.duration || 0, player.currentTime + 5);
    if (e.key === 'ArrowLeft') player.currentTime = Math.max(0, player.currentTime - 5);
    if (e.key === 'm') { player.muted = !player.muted; btnMute.textContent = player.muted ? 'üîá':'üîà'; }
  });

  // Init
  function init(){
    loadState();
    preloadSamples().then(()=>{ renderPlaylist(); playIndex(0); renderComments(); });
  }

  init();

  // expose for debugging
  window.MiniTube = {
    getPlaylist: ()=>playlist,
    playIndex,
    addSample: (url, title, type)=> { playlist.push({ id: cryptoRandomId(), title, src: url, type }); renderPlaylist(); saveState(); }
  };

})();
</script>
</body>
</html>
